# If you come from bash you might have to change your $PATH.
# export PATH=$HOME/bin:/usr/local/bin:$PATH
export PATH="/home/dawheat/.local/bin:$PATH"

# Add Snap to path
export PATH="/snap/bin:$PATH"

# Initialize Homebrew
eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"


# Bitwarden helper
bwunlock() {
    if [ -n "$BW_SESSION" ]; then
        echo "Bitwarden already unlocked"
        return 0
    fi
    
    BW_STATUS=$(bw status 2>/dev/null | jq -r '.status')
    
    if [ "$BW_STATUS" = "unauthenticated" ]; then
        echo "Logging in to Bitwarden..."
        bw login
        BW_STATUS=$(bw status | jq -r '.status')
    fi
    
    if [ "$BW_STATUS" = "locked" ]; then
        echo "Unlocking Bitwarden vault..."
        export BW_SESSION=$(bw unlock --raw)
    fi
}

# Wrapper for chezmoi that ensures Bitwarden is unlocked
chezmoi() {
    case "$1" in
        apply|update|init)
            bwunlock
            ;;
    esac
    command chezmoi "$@"
}

# Offer to unlock Bitwarden on shell startup
if [ -z "$BW_SESSION" ]; then
    BW_STATUS=$(bw status 2>/dev/null | jq -r '.status')

    if [ "$BW_STATUS" = "locked" ] || [ "$BW_STATUS" = "unauthenticated" ]; then
        echo -n "Bitwarden is locked. Unlock now? (Y/n): "
        read -r response
        if [[ ! "$response" =~ ^[Nn]$ ]]; then
            bwunlock
        fi
    fi
fi

# Set zstyles for antidote configuration
zstyle ':antidote:bundle' use-friendly-names 'yes'

# Clone antidote if necessary and initialize
if [[ ! -d ${HOME}/.antidote ]]; then
  git clone --depth=1 https://github.com/mattmc3/antidote ${HOME}/.antidote
fi

# Initialize antidote plugin manager
source ${HOME}/.antidote/antidote.zsh
antidote load


alias bat='batcat'
alias cat='batcat'

alias l='exa --icons --group-directories-first --git --header'
alias ls='exa --icons --group-directories-first --git --header -1'
alias ll='exa --icons --group-directories-first --git --long --header'
alias la='exa --icons --group-directories-first --git --long --all --header'

alias cdr='cd ~/repos'


# SSH Agent configuration
if [ -z "$SSH_AUTH_SOCK" ]; then
    # Try to restore from saved state first
    if [ -f "$HOME/.ssh/ssh-agent" ]; then
        eval `command cat $HOME/.ssh/ssh-agent`
    fi

    # If still no valid socket (file doesn't exist or agent died), start a new agent
    if [ -z "$SSH_AUTH_SOCK" ]; then
        ssh-agent -s &> $HOME/.ssh/ssh-agent
        eval `command cat $HOME/.ssh/ssh-agent`
    fi
fi

# Auto-load SSH key with passphrase from Bitwarden
if [ -n "$SSH_AUTH_SOCK" ] && [ -n "$BW_SESSION" ]; then
    # Check if key is already loaded
    SSH_KEY_PATH="$HOME/.ssh/id_ed25519"
    if [ -f "$SSH_KEY_PATH" ]; then
        # Get the key fingerprint to check if already loaded
        KEY_FINGERPRINT=$(ssh-keygen -lf "$SSH_KEY_PATH" 2>/dev/null | awk '{print $2}')

        # Check if this key is already in the agent
        if ! ssh-add -l 2>/dev/null | grep -q "$KEY_FINGERPRINT"; then
            # Create SSH_ASKPASS helper script in /tmp with restrictive permissions
            SSH_ASKPASS_SCRIPT="/tmp/.ssh-askpass-$$.sh"
            cat > "$SSH_ASKPASS_SCRIPT" << 'ASKPASS_EOF'
#!/bin/sh
# SSH_ASKPASS helper - retrieves passphrase from Bitwarden
echo '{{ (bitwardenFields "item" "SSH Key - GitHub").passkey.value }}'
ASKPASS_EOF
            chmod 700 "$SSH_ASKPASS_SCRIPT"

            # Use SSH_ASKPASS to add key non-interactively
            DISPLAY=:0 SSH_ASKPASS="$SSH_ASKPASS_SCRIPT" SSH_ASKPASS_REQUIRE=force ssh-add "$SSH_KEY_PATH" 2>/dev/null

            # Clean up helper script immediately
            rm -f "$SSH_ASKPASS_SCRIPT"
        fi
    fi
elif [ -n "$SSH_AUTH_SOCK" ] && [ -z "$BW_SESSION" ]; then
    # SSH agent is running but Bitwarden not unlocked - inform user
    echo "Note: SSH agent running, but SSH key not auto-loaded (Bitwarden locked)"
fi

# Add environment variables from BitWarden (loops through all fields in the item)
{{- range $key, $field := (bitwardenFields "item" "API Keys - zsh ENV") }}
export {{ $key }}={{ $field.value }}
{{- end }}

# Initialize Starship prompt
eval "$(starship init zsh)"
