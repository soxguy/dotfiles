# ~/.config/zsh/secrets.zsh
#
# Bitwarden integration, SSH agent setup, and SSH key auto-loading
# MUST be sourced (not executed) to set BW_SESSION and SSH_AUTH_SOCK
# Only loaded for interactive shells (loader handles this)

# ============================================================================
# Bitwarden Helper Functions
# ============================================================================

bwunlock() {
    if [ -n "$BW_SESSION" ]; then
        echo "Bitwarden already unlocked"
        return 0
    fi

    BW_STATUS=$(bw status 2>/dev/null | jq -r '.status')

    if [ "$BW_STATUS" = "unauthenticated" ]; then
        echo "Logging in to Bitwarden..."
        bw login
        BW_STATUS=$(bw status | jq -r '.status')
    fi

    if [ "$BW_STATUS" = "locked" ]; then
        while true; do
            echo "Unlocking Bitwarden vault..."
            export BW_SESSION=$(bw unlock --raw)

            # Verify unlock was successful
            BW_STATUS=$(bw status 2>/dev/null | jq -r '.status')
            if [ "$BW_STATUS" = "unlocked" ]; then
                echo "Syncing Bitwarden vault..."
                bw sync
                break
            fi

            # Unlock failed, ask to retry or cancel
            echo -n "Unlock failed. Try again? (Y/n): "
            read -r response
            if [[ "$response" =~ ^[Nn]$ ]]; then
                echo "Bitwarden unlock cancelled"
                return 1
            fi
        done
    fi
}

# Wrapper for chezmoi that ensures Bitwarden is unlocked
chezmoi() {
    case "$1" in
        apply|update|init)
            bwunlock
            ;;
    esac
    command chezmoi "$@"
}

# ============================================================================
# Bitwarden Unlock on Startup
# ============================================================================

# Offer to unlock Bitwarden on shell startup
if [ -z "$BW_SESSION" ]; then
    BW_STATUS=$(bw status 2>/dev/null | jq -r '.status')

    if [ "$BW_STATUS" = "locked" ] || [ "$BW_STATUS" = "unauthenticated" ]; then
        echo -n "Bitwarden is locked. Unlock now? (Y/n): "
        read -r response
        if [[ ! "$response" =~ ^[Nn]$ ]]; then
            bwunlock
        fi
    fi
fi

# ============================================================================
# SSH Agent Configuration
# ============================================================================

if [ -z "$SSH_AUTH_SOCK" ]; then
    # Try to restore from saved state first
    if [ -f "$HOME/.ssh/ssh-agent" ]; then
        eval `command cat $HOME/.ssh/ssh-agent`
    fi

    # If still no valid socket (file doesn't exist or agent died), start a new agent
    if [ -z "$SSH_AUTH_SOCK" ]; then
        ssh-agent -s &> $HOME/.ssh/ssh-agent
        eval `command cat $HOME/.ssh/ssh-agent`
    fi
fi

# ============================================================================
# Auto-load SSH Key with Passphrase from Bitwarden
# ============================================================================

# Auto-load SSH key with passphrase from Bitwarden
if [ -n "$SSH_AUTH_SOCK" ] && [ -n "$BW_SESSION" ]; then
    # Check if key is already loaded
    SSH_KEY_PATH="$HOME/.ssh/id_ed25519"
    if [ -f "$SSH_KEY_PATH" ]; then
        # Get the key fingerprint to check if already loaded
        KEY_FINGERPRINT=$(ssh-keygen -lf "$SSH_KEY_PATH" 2>/dev/null | awk '{print $2}')

        # Check if this key is already in the agent
        if ! ssh-add -l 2>/dev/null | grep -q "$KEY_FINGERPRINT"; then
            # Store passphrase from Bitwarden (evaluated at chezmoi apply time)
            SSH_PASSPHRASE='{{ (bitwardenFields "item" "SSH Key - GitHub").passkey.value }}'

            # Use expect to add key non-interactively
            SSH_KEY_PATH="$SSH_KEY_PATH" SSH_PASSPHRASE="$SSH_PASSPHRASE" expect >/dev/null 2>&1 <<'EXPECT_EOF'
log_user 0
set timeout 10
spawn ssh-add $env(SSH_KEY_PATH)
expect {
    -re "Enter passphrase.*:" {
        send "$env(SSH_PASSPHRASE)\r"
        exp_continue
    }
    "Identity added" {
        exit 0
    }
    "Bad passphrase" {
        exit 2
    }
    timeout {
        exit 3
    }
    eof
}
EXPECT_EOF

            # Optional: Check exit code and warn on failure
            EXPECT_EXIT=$?
            if [ $EXPECT_EXIT -ne 0 ]; then
                echo "Warning: Failed to auto-load SSH key (exit code: $EXPECT_EXIT)" >&2
            fi
        fi
    fi
elif [ -n "$SSH_AUTH_SOCK" ] && [ -z "$BW_SESSION" ]; then
    # SSH agent is running but Bitwarden not unlocked - inform user
    echo "Note: SSH agent running, but SSH key not auto-loaded (Bitwarden locked)"
fi
