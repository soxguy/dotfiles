#!/bin/bash
# This runs automatically after 'chezmoi apply' or 'chezmoi update'
# Triggers ansible-pull to ensure system packages/tools are up to date

set -e

# Only run if ansible-pull is installed
if ! command -v ansible-pull &> /dev/null; then
    echo "Note: ansible-pull not installed, skipping system configuration"
    exit 0
fi

# Get GitHub user for dotfiles repo
# Use environment variable if set, otherwise default to 'soxguy' (public repo)
GITHUB_USER="${GITHUB_USER:-soxguy}"

echo "Running ansible-pull to update system packages and tools..."
echo "Repository: https://github.com/$GITHUB_USER/dotfiles.git"
echo ""

# Source exports to get BW_LOCAL_ACCT and other environment variables
if [ -f "$HOME/.config/zsh/exports.zsh" ]; then
    source "$HOME/.config/zsh/exports.zsh"
fi

# Check if Bitwarden is unlocked
if ! bw status | jq -e '.status == "unlocked"' > /dev/null 2>&1; then
    echo "Error: Bitwarden vault must be unlocked to retrieve sudo password"
    echo "Run 'bwunlock' to unlock your vault"
    exit 1
fi

# Check if BW_LOCAL_ACCT is set
if [ -z "$BW_LOCAL_ACCT" ]; then
    echo "Error: BW_LOCAL_ACCT environment variable not set"
    echo "This should be exported from ~/.config/zsh/exports.zsh"
    exit 1
fi

# Retrieve sudo password from Bitwarden
SUDO_PASSWORD=$(bw get password "$BW_LOCAL_ACCT" 2>/dev/null)
if [ -z "$SUDO_PASSWORD" ]; then
    echo "Error: Could not retrieve password from Bitwarden item '$BW_LOCAL_ACCT'"
    echo "Please ensure the item exists and contains a password"
    exit 1
fi

# Change to chezmoi source directory to ensure we're using committed playbooks
cd "{{ .chezmoi.sourceDir }}"

# Run ansible-pull with sudo password from Bitwarden
# Pass password via ANSIBLE_BECOME_PASS environment variable
ANSIBLE_BECOME_PASS="$SUDO_PASSWORD" ansible-pull \
    --directory ~/.local/share/ansible-pull \
    --url "https://github.com/$GITHUB_USER/dotfiles.git" \
    ansible/local.yml

echo ""
echo "Ansible configuration complete!"
